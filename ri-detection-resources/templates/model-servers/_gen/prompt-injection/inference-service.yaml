{{- if and .Values.modelServers.promptInjection.enabled (not .Values.modelServers.promptInjection.remoteModelServer.enabled) }}
# Autogenerated by a script. DO NOT EDIT.
apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: prompt-injection
  annotations:
    {{- include "ri-detection-resources.annotations" . | nindent 4 }}
spec:
  predictor:
    {{- with .Values.images.imagePullSecrets }}
    imagePullSecrets:
      {{- toYaml . | nindent 8 }}
    {{- end }}
    minReplicas: {{ .Values.modelServers.promptInjection.minReplicas }}
    maxReplicas: {{ .Values.modelServers.promptInjection.maxReplicas }}
    containers:
      - name: prompt-injection
        image: "{{ .Values.images.modelServerImage.registry}}/{{ .Values.images.modelServerImage.name }}"
        imagePullPolicy: {{ .Values.images.modelServerImage.pullPolicy }}
        env:
          - name: HUGGINGFACE_API_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.secrets.existingIntegrationSecretsName }}
                key: huggingfaceAPIKey
        ports:
          - name: rest
            protocol: TCP
            containerPort: 8080
        command:
          - "run_server"
        args:
          - "--model-config-path=/model_server/model-settings.json"
          - "--cache-dir=/model_cache"
        startupProbe:
          httpGet:
            path: /v2/models/prompt-injection/ready
            port: 8080
          failureThreshold: 20
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /v2/models/prompt-injection/ready
            port: 8080
          periodSeconds: 5
        resources:
          requests:
            memory: {{ .Values.modelServers.promptInjection.resources.requests.memory }}
            cpu: {{ .Values.modelServers.promptInjection.resources.requests.cpu }}
          limits:
            memory: {{ .Values.modelServers.promptInjection.resources.limits.memory }}
            cpu: {{ .Values.modelServers.promptInjection.resources.limits.cpu }}
        volumeMounts:
          - name: prompt-injection-config
            mountPath: "/model_server"
            readOnly: true
          - name: prompt-injection-model-cache
            mountPath: "/model_cache"
            readOnly: false
    volumes:
      # Volumes are defined at the Pod level, then mounted into containers within that Pod
      - name: prompt-injection-config
        configMap:
          name: {{ include "ri-detection-resources.fullname" . }}-prompt-injection-conf
          items:
            - key: "model-settings.json"
              path: "model-settings.json"
      - name: prompt-injection-model-cache
        emptyDir: { }
{{- end }}
