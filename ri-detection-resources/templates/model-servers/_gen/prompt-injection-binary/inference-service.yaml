{{- if and .Values.modelServers.promptInjectionBinary.enabled (not .Values.modelServers.promptInjectionBinary.remoteModelServer.enabled) }}
# Autogenerated by a script. DO NOT EDIT.
apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: prompt-injection-binary
  annotations:
    {{- include "ri-detection-resources.annotations" . | nindent 4 }}
spec:
  predictor:
    {{- with .Values.images.imagePullSecrets }}
    imagePullSecrets:
      {{- toYaml . | nindent 8 }}
    {{- end }}
    minReplicas: {{ .Values.modelServers.promptInjectionBinary.minReplicas }}
    maxReplicas: {{ .Values.modelServers.promptInjectionBinary.maxReplicas }}
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
    containers:
      - name: prompt-injection-binary
      {{- if .Values.modelServers.promptInjectionBinary.useCachedArtifact.enabled }}
        image: "{{ .Values.modelServers.promptInjectionBinary.useCachedArtifact.dockerImageOverride.registry }}/{{ .Values.modelServers.promptInjectionBinary.useCachedArtifact.dockerImageOverride.name }}"
        imagePullPolicy: {{ .Values.modelServers.promptInjectionBinary.useCachedArtifact.dockerImageOverride.pullPolicy }}
      {{- else }}
        image: "{{ .Values.images.modelServerImage.registry}}/{{ .Values.images.modelServerImage.name }}"
        imagePullPolicy: {{ .Values.images.modelServerImage.pullPolicy }}
      {{- end }}
        env:
        {{- if not .Values.modelServers.promptInjectionBinary.useCachedArtifact.enabled }}
          - name: HUGGINGFACE_API_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.secrets.existingIntegrationSecretsName }}
                key: huggingfaceAPIKey
        {{- end }}
        ports:
          - name: rest
            protocol: TCP
            containerPort: 8080
        command:
          - "run_server"
        args:
          - "--model-config-path=/model_server/model-settings.json"
          - "--cache-dir=/model_cache"
        startupProbe:
          httpGet:
            path: /v2/models/prompt-injection-binary/ready
            port: 8080
          failureThreshold: 20
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /v2/models/prompt-injection-binary/ready
            port: 8080
          periodSeconds: 5
        resources:
          requests:
            memory: {{ .Values.modelServers.promptInjectionBinary.resources.requests.memory }}
            cpu: {{ .Values.modelServers.promptInjectionBinary.resources.requests.cpu }}
          limits:
            memory: {{ .Values.modelServers.promptInjectionBinary.resources.limits.memory }}
            cpu: {{ .Values.modelServers.promptInjectionBinary.resources.limits.cpu }}
        volumeMounts:
          - name: prompt-injection-binary-config
            mountPath: "/model_server"
            readOnly: true
          - name: prompt-injection-binary-model-cache
            mountPath: "/model_cache"
            readOnly: false
    volumes:
      # Volumes are defined at the Pod level, then mounted into containers within that Pod
      - name: prompt-injection-binary-config
        configMap:
          name: {{ include "ri-detection-resources.fullname" . }}-prompt-injection-binary-conf
          items:
            - key: "model-settings.json"
              path: "model-settings.json"
      - name: prompt-injection-binary-model-cache
        emptyDir: { }
{{- end }}
